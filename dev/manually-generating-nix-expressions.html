<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Manually generating Nix expressions - Alternative Haskell Infrastructure for Nixpkgs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Manually generating Nix expressions";
    var mkdocs_page_input_path = "dev/manually-generating-nix-expressions.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Alternative Haskell Infrastructure for Nixpkgs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../motivation.html">Motivation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started.html">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-flakes.html">Getting started with Flakes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/getting-started-hix.html">Getting started with Hix</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/development.html">Creating a development environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/clean-git.html">Sourcing files only part of git repository using cleanGit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/source-repository-hashes.html">Handling git repositories in projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/pkg-map.html">Mapping non-Haskell dependencies to Nixpkgs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/hackage-stackage.html">Bumping Hackage and Stackage snapshots</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/materialization.html">Materialization: Speeding up Nix evaluation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/cross-compilation.html">Cross-compiling your project</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/coverage.html">Generating coverage information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/building-package-from-stackage-hackage.html">Build a specific package from Hackage or Stackage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../tutorials/ca-derivations.html">Content addressed derivations</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/supported-ghc-versions.html">Supported GHC versions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/commands.html">Command-line tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/library.html">Haskell.nix Library</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/modules.html">Module options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Templates / Abstraction</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../iohk-nix.html">IOHKs nix library</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Dev Notes</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="dev-architecture.html">Architecture</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="installing-nix-tools.html">Installing nix-tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="nix-tools-pin.html">How to update nix-tools</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="manually-generating-nix-expressions.html">Manually generating Nix expressions</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#using-stack">Using Stack</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-cabal">Using Cabal</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#generating-planjson">Generating plan.json</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using-plan-to-nix">Using plan-to-nix</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="maintainer-scripts.html">Maintainer Scripts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="nixpkgs-pin.html">Nixpkgs Pin</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="removing-with-package-wrapper.html">Removing withPackage wrapper</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tests.html">Test Suite</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="adding-new-ghc.html">Adding a new GHC version</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="coverage.html">Coverage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="hix.html">Making changes to Hix</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../changelog.html">ChangeLog</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Alternative Haskell Infrastructure for Nixpkgs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Dev Notes &raquo;</li>
        
      
    
    <li>Manually generating Nix expressions</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/input-output-hk/haskell.nix/edit/master/docs/dev/manually-generating-nix-expressions.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="manually-generating-nix-expressions">Manually generating Nix expressions<a class="headerlink" href="#manually-generating-nix-expressions" title="Permanent link">&para;</a></h1>
<p>We believe that imports from derivations (IFDs) provide tremendous
value in nix and the aversion towards them stems mostly from
poor tooling and ci support for them.  We do not believe
that poor tooling or ci support should cripple nix capability
of abstraction.  Hence haskell.nix makes excessive use of
IFDs.</p>
<p>We do note however that there are users who prefer to
have IFD-free expressions.  For this group of users we
detail how to expand the IFD dependent high level functions
into their IFD free building blocks.</p>
<p>The general structure will be the same, independent of the use of
Stack or Cabal.</p>
<p>Let us assume for now that we have already generated a <code>pkgs.nix</code>
expression (see the links bellow). The following file then produces a package set:</p>
<pre><code class="language-nix"># default.nix
let
  # Import the Haskell.nix library,
  pkgs = import &lt;nixpkgs&gt; (import (builtins.fetchTarball https://github.com/input-output-hk/haskell.nix/archive/master.tar.gz) {}).nixpkgsArgs;

  # Import the file you will create in the stack-to-nix or cabal-to-nix step.
  my-pkgs = import ./pkgs.nix;

  # Stack projects use this:
  pkgSet = pkgs.haskell-nix.mkStackPkgSet {
    stack-pkgs = my-pkgs;
    pkg-def-extras = [
      # these extras will provide additional packages
      # ontop of the package set.  E.g. extra-deps
      # for stack packages. or local packages for
      # cabal.projects
    ];
    modules = [
      # specific package overrides would go here
      # example:
      #  packages.cbors.package.ghcOptions = &quot;-Werror&quot;;
      #  packages.cbors.patches = [ ./one.patch ];
      #  packages.cbors.flags.optimize-gmp = false;
      # It may be better to set flags in stack.yaml instead
      # (`stack-to-nix` will include them as defaults).
    ];
  };

  # Cabal projects use this:
  pkgSet = pkgs.haskell-nix.mkCabalProjectPkgSet {
    plan-pkgs = my-pkgs;
    pkg-def-extras = [];
    modules = [
      # specific package overrides would go here
      # example:
      #  packages.cbors.package.ghcOptions = &quot;-Werror&quot;;
      #  packages.cbors.patches = [ ./one.patch ];
      #  packages.cbors.flags.optimize-gmp = false;
      # It may be better to set flags in `cabal.project` instead
      # (`plan-to-nix` will include them as defaults).
    ];
  };

in pkgSet.config.hsPkgs // { _config = pkgSet.config; }
</code></pre>
<p>With this setup you can then start building the components of
interest:</p>
<pre><code class="language-bash">nix build -f default.nix $pkg.components.library
</code></pre>
<p>to build the library for <code>$pkg</code> or</p>
<pre><code class="language-bash">nix build -f default.nix $pkg.components.exes.$exe
</code></pre>
<p>to build a specific executable. The same holds for test suites and benchmarks.</p>
<h2 id="using-stack">Using Stack<a class="headerlink" href="#using-stack" title="Permanent link">&para;</a></h2>
<p>With <a href="installing-nix-tools.html">nix-tools installed</a>, we can simply run the
following command on a stack project:</p>
<pre><code class="language-bash">stack-to-nix --output . --stack-yaml stack.yaml
</code></pre>
<p>This will produce a <code>pkgs.nix</code> file that looks like the following:</p>
<pre><code class="language-nix">{
  resolver = &quot;lts-12.17&quot;;
  extras = hackage:
    {
      packages = {
        &quot;o-clock&quot; = hackage.o-clock.&quot;0.1.1&quot;.revisions.default;
        ...
      } // {
        my-package = ./my-package.nix;
        ...
      };
    };
}
</code></pre>
<p>This file contains the stackage resolver, as well as set of extra
packages.  The extras specifies which <code>extra-deps</code> (here:
<code>o-clock-0.1.1</code>) we wanted to add over the stackage snapshot, and what
local packages we want (here: <code>my-package</code>).</p>
<h2 id="using-cabal">Using Cabal<a class="headerlink" href="#using-cabal" title="Permanent link">&para;</a></h2>
<h3 id="generating-planjson">Generating <code>plan.json</code><a class="headerlink" href="#generating-planjson" title="Permanent link">&para;</a></h3>
<p>To get a plan, you need Cabal and GHC. See the <a href="https://nixos.org/nixpkgs/manual/#how-to-install-a-compiler">How to install a
compiler section of the Nixpkgs Manual</a> for information
about how to choose a specific compiler version.</p>
<div class="admonition note">
<p class="admonition-title">Cabal version</p>
<p>The minimum Cabal version is 2.4. This version is available
in the NixOS 19.03 release.</p>
</div>
<p>For this example, we will run a <code>nix-shell</code> with the default GHC
version for Nixpkgs.</p>
<pre><code class="language-bash">nix-shell -p haskellPackages.cabal-install haskellPackages.ghc \
    --run &quot;cabal new-configure&quot;
</code></pre>
<p>If all goes well, you should now have the file
<code>dist-newstyle/cache/plan.json</code>.</p>
<div class="admonition tip">
<p class="admonition-title">Specifying the GHC version</p>
<p>To use a specific compiler version, replace <code>haskellPackages.ghc</code>
with something like <code>haskell-nix.compiler.ghc865</code>. The given compiler
must exist in your Nixpkgs version, of course. See also the
<a href="https://nixos.org/nixpkgs/manual/#how-to-install-a-compiler">Nixpkgs Manual</a>.</p>
</div>
<h3 id="using-plan-to-nix">Using <code>plan-to-nix</code><a class="headerlink" href="#using-plan-to-nix" title="Permanent link">&para;</a></h3>
<p>With <a href="installing-nix-tools.html">nix-tools installed</a>, we can then run the
following command on a Cabal project and its build plan. Omit the
<code>--cabal-project</code> option if you don't have a project file.</p>
<pre><code class="language-bash"># convert the plan.json file into a pkgs.nix file
plan-to-nix --output . \
    --plan-json dist-newstyle/cache/plan.json
    --cabal-project cabal.project
</code></pre>
<p>This will produce a <code>pkgs.nix</code> file that looks like the following:</p>
<pre><code class="language-nix">{
  pkgs = hackage:
    {
      packages = {
        &quot;o-clock&quot; = hackage.o-clock.&quot;0.1.1&quot;.revisions.default;
        ...
      };
      compiler = { ... };
    };

  extras = hackage:
    { packages = { my-package = ./.plan.nix/my-package.nix; }; };
}
</code></pre>
<p>It has converted Cabal's build plan into a Nix expression that selects
dependencies from <code>hackage.nix</code>. All local packages in the project are
generated with <code>cabal-to-nix</code> and added to the package set
description.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="maintainer-scripts.html" class="btn btn-neutral float-right" title="Maintainer Scripts">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="nix-tools-pin.html" class="btn btn-neutral" title="How to update nix-tools"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/input-output-hk/haskell.nix/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="nix-tools-pin.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="maintainer-scripts.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
