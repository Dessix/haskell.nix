<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Content addressed derivations - Alternative Haskell Infrastructure for Nixpkgs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Content addressed derivations";
    var mkdocs_page_input_path = "tutorials/ca-derivations.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Alternative Haskell Infrastructure for Nixpkgs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../motivation.html">Motivation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="getting-started-flakes.html">Getting started with Flakes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="getting-started-hix.html">Getting started with Hix</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="development.html">Creating a development environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="clean-git.html">Sourcing files only part of git repository using cleanGit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="source-repository-hashes.html">Handling git repositories in projects</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pkg-map.html">Mapping non-Haskell dependencies to Nixpkgs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="hackage-stackage.html">Bumping Hackage and Stackage snapshots</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="materialization.html">Materialization: Speeding up Nix evaluation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="cross-compilation.html">Cross-compiling your project</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="coverage.html">Generating coverage information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="building-package-from-stackage-hackage.html">Build a specific package from Hackage or Stackage</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="ca-derivations.html">Content addressed derivations</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#enable-ca-derivations-in-your-system">Enable CA derivations in your system</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-ca-derivations-in-your-project">Enable CA derivations in your project</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#known-problems">Known problems</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#limitation-of-the-current-ca-derivations-implementation">Limitation of the current CA derivations implementation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#hydra">Hydra</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ghc-is-not-deterministic">GHC is not deterministic</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/supported-ghc-versions.html">Supported GHC versions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/commands.html">Command-line tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/library.html">Haskell.nix Library</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reference/modules.html">Module options</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Templates / Abstraction</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../iohk-nix.html">IOHKs nix library</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Dev Notes</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/dev-architecture.html">Architecture</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/installing-nix-tools.html">Installing nix-tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/nix-tools-pin.html">How to update nix-tools</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/manually-generating-nix-expressions.html">Manually generating Nix expressions</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/maintainer-scripts.html">Maintainer Scripts</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/nixpkgs-pin.html">Nixpkgs Pin</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/removing-with-package-wrapper.html">Removing withPackage wrapper</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/tests.html">Test Suite</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/adding-new-ghc.html">Adding a new GHC version</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/coverage.html">Coverage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../dev/hix.html">Making changes to Hix</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../changelog.html">ChangeLog</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Alternative Haskell Infrastructure for Nixpkgs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorials &raquo;</li>
        
      
    
    <li>Content addressed derivations</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/input-output-hk/haskell.nix/edit/master/docs/tutorials/ca-derivations.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="content-addressed-derivations">Content addressed derivations<a class="headerlink" href="#content-addressed-derivations" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Floating content addressed derivations (from now <em>CA derivations</em>) is an experimental feature which substantially change how the hashes in the store paths are calculated.
Indeed, normally derivations are input addressed i.e. the outputs store paths depends only on the derivation inputs, instead with CA derivations they depend on the content of the outputs.</p>
<p>This has two main advantages:</p>
<ul>
<li>The so-called "early cutoff", namely the ability of Nix to stop a build if the build outputs would be something already built. 
For example suppose you add a comment in an Haskell source, at this point Nix will rebuild the component depending on this source but since the output will be the same (adding a comment is an "output-invariant" change for <code>ghc</code>) every other component that depends on that will not be rebuilt.</li>
<li>Users of the same Nix store does not need to trust each other when using substituters.</li>
</ul>
<p>You can find more information in the <a href="https://nixos.wiki/wiki/Ca-derivations">ca-derivations page on the wiki</a> (and in the other resources linked there).</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="enable-ca-derivations-in-your-system">Enable CA derivations in your system<a class="headerlink" href="#enable-ca-derivations-in-your-system" title="Permanent link">&para;</a></h3>
<p>First of all your Nix installation must support the <code>ca-derivations</code> experimental feature, this can done by adding the following in your <code>nix.conf</code>:</p>
<pre><code>experimental-features = ca-derivations
</code></pre>
<p>Or if you use NixOS:</p>
<pre><code>nix.extraOptions = ''
    experimental-features = ca-derivations
'';
</code></pre>
<h2 id="enable-ca-derivations-in-your-project">Enable CA derivations in your project<a class="headerlink" href="#enable-ca-derivations-in-your-project" title="Permanent link">&para;</a></h2>
<p>At this point you can pass a new module to <code>project'</code> that tells <code>haskell.nix</code> to build every component in the project as CA derivation.</p>
<pre><code>haskell-nix.project' {
    # ...

    modules = [{
        contentAddressed = true;
        # packages.project-name.components.exes.executable.contentAddressed = true;
    }];
};
</code></pre>
<p>Optionally you can also specify which components you don't want to be content addressed.</p>
<h2 id="known-problems">Known problems<a class="headerlink" href="#known-problems" title="Permanent link">&para;</a></h2>
<h3 id="limitation-of-the-current-ca-derivations-implementation">Limitation of the current CA derivations implementation<a class="headerlink" href="#limitation-of-the-current-ca-derivations-implementation" title="Permanent link">&para;</a></h3>
<p>As explained in the <a href="https://github.com/tweag/rfcs/blob/cas-rfc/rfcs/0062-content-addressed-paths.md">RFC 62</a></p>
<blockquote>
<p>The current implementation has a naive approach that just forbids fetching a path if the local system has a different realisation for the same drv output. This approach is simple and correct, but it's possible that it might not be good-enough in practice as it can result in a totally useless binary cache in some pathological cases.</p>
</blockquote>
<p>For example, suppose that your machine builds a derivation <code>A</code> producing an output <code>A.out</code> in your store and that after that a CI machine builds the same derivation <code>A</code> but producing a different output <code>A.out'</code> and populating a cache with this output.
At this point, if you need to build a derivation <code>B</code> that depends on <code>A</code>, since you already have the realisation <code>A.out</code> in your local store and you can't get <code>B.out</code> from the cache and you will end up building <code>B</code> even if one of its realisation is in the cache.</p>
<p>This means that, in some cases, enabling CA derivations would lead to more rebuilds than not having it.</p>
<h3 id="hydra">Hydra<a class="headerlink" href="#hydra" title="Permanent link">&para;</a></h3>
<p>Hydra currently doesn't support CA derivations, efforts are being made in this direction.</p>
<h3 id="ghc-is-not-deterministic">GHC is not deterministic<a class="headerlink" href="#ghc-is-not-deterministic" title="Permanent link">&para;</a></h3>
<p>Currently <code>ghc</code> is determinstic only disabling the parallel building i.e. passing <code>-j1</code>. <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/12935">Here</a> the upstream issue.</p>
<p>Having a deterministic <code>ghc</code> would be a dream since it will automatically fix all the pathological cases about substituters discussed above and would allow <code>haskell.nix</code> to parallel build even when using CA derivations.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reference/supported-ghc-versions.html" class="btn btn-neutral float-right" title="Supported GHC versions">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="building-package-from-stackage-hackage.html" class="btn btn-neutral" title="Build a specific package from Hackage or Stackage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/input-output-hk/haskell.nix/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="building-package-from-stackage-hackage.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../reference/supported-ghc-versions.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
